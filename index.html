<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lista 1 - Valentine's Box</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Montserrat:wght@500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        'nw-dark': '#1a0005', 
                        'nw-neon': '#FFB7C5',
                        'nw-red': '#D32F2F', 
                        'nw-pink': '#FF4081'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(40px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CORE STYLES --- */
        html, body {
            width: 100%;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background: transparent;
        }

        /* 1. SFONDO FISSO ANIMATO (Gradiente San Valentino) */
        .fixed-background {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -50;
            background: linear-gradient(-45deg, #4a0404, #880e4f, #ad1457, #d32f2f);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            will-change: background-position;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 2. PARTICELLE CUORI */
        .hearts-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; 
            z-index: -40; 
            pointer-events: none;
        }
        
        .heart-particle {
            position: absolute;
            bottom: -10vh;
            color: rgba(255, 64, 129, 0.6); 
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            animation: floatUp linear infinite;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            80% { opacity: 0.6; }
            100% { transform: translateY(-120vh) rotate(360deg); opacity: 0; }
        }

        .glass-panel {
            background: rgba(80, 0, 20, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
        }

        /* 3. INVERSIONE BAGLIORI */
        /* Scritta Bianca -> Bagliore Rosa/Rosso */
        .glow-white-inv { 
            color: #ffffff;
            text-shadow: 0 0 10px #FF4081, 0 0 20px #FF0055, 0 0 30px #FF0055; 
        }
        /* Scritta Rosa -> Bagliore Bianco */
        .glow-pink-inv { 
            color: #FF4081;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.9), 0 0 25px rgba(255, 255, 255, 0.6); 
        }

        .delay-100 { animation-delay: 100ms; }
        .delay-200 { animation-delay: 200ms; }

        .view-section {
            display: none; opacity: 0; 
            min-height: 80vh;
            width: 100%;
        }
        .view-section.active {
            display: flex; opacity: 1; 
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #ffffff;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .masonry-grid { column-count: 1; }
        @media (min-width: 640px) { .masonry-grid { column-count: 2; } }
        @media (min-width: 1024px) { .masonry-grid { column-count: 3; } }
        .masonry-item { break-inside: avoid; margin-bottom: 1.5rem; }

        /* COUNTDOWN */
        .countdown-box {
            display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;
        }
        .countdown-unit {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 0.75rem 1.25rem;
            min-width: 70px;
            text-align: center;
        }
        .countdown-number {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 2rem;
            line-height: 1;
            color: #FF4081;
            text-shadow: 0 0 12px rgba(255,255,255,0.7);
        }
        .countdown-label {
            font-size: 0.6rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.6);
            margin-top: 0.25rem;
        }
        /* SEARCH BAR */
        .search-bar {
            width: 100%; max-width: 480px;
            background: rgba(0,0,0,0.25);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 1rem;
            padding: 0.85rem 1.25rem;
            color: white;
            font-size: 0.95rem;
            font-weight: 500;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-bar::placeholder { color: rgba(255,255,255,0.45); }
        .search-bar:focus { border-color: #FF4081; }

        /* BADGE COUNT */
        .count-badge {
            display: inline-block;
            background: rgba(255,64,129,0.25);
            border: 1px solid rgba(255,64,129,0.5);
            color: #FF4081;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 999px;
            padding: 0.15rem 0.65rem;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        /* TIMESTAMP */
        .msg-timestamp {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.35);
            margin-top: 0.75rem;
            font-weight: 500;
        }

        /* ADMIN TABS */
        .admin-tab-btn {
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.6);
        }
        .admin-tab-btn:hover { background: rgba(255,255,255,0.12); color: white; }
        .active-tab {
            background: rgba(255,64,129,0.25) !important;
            border-color: rgba(255,64,129,0.6) !important;
            color: white !important;
        }
        .admin-panel { display: flex; flex-direction: column; }
        .admin-panel.hidden { display: none !important; }

        /* EMAIL STATUS BADGES */
        .email-sent    { background: rgba(34,197,94,0.2); border:1px solid rgba(34,197,94,0.5); color:#4ade80; }
        .email-failed  { background: rgba(239,68,68,0.2); border:1px solid rgba(239,68,68,0.5); color:#f87171; }
        .email-skipped { background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2); color:rgba(255,255,255,0.45); }
        .email-badge {
            font-size: 0.65rem; font-weight: 700; border-radius: 999px;
            padding: 0.1rem 0.55rem; display: inline-block; margin-top: 0.4rem;
        }
    </style>
</head>
<body class="font-sans antialiased text-white selection:bg-white selection:text-nw-pink">

    <div class="fixed-background"></div>

    <div class="hearts-container" id="heartsBg"></div>

    <nav class="w-full glass-panel fixed top-0 z-50 px-6 py-4 flex justify-between items-center border-b-white/10 transition-all duration-300">
        <div class="font-display font-black text-xl tracking-tighter cursor-pointer text-white hover:text-nw-pink transition-colors flex items-center gap-2" onclick="app.router('home')">
            <span class="text-2xl animate-pulse-slow">üíñ</span> LISTA 1 <span class="glow-pink-inv">NEW WAVE</span>
        </div>
        <div class="space-x-4 text-sm font-bold tracking-wider hidden md:block">
            <button onclick="app.router('home')" class="hover:text-nw-pink transition">HOME</button>
            <button onclick="app.router('wall')" class="hover:text-nw-pink transition">WALL OF LOVE</button>
        </div>
    </nav>

    <main class="relative w-full min-h-screen pt-24 pb-0 flex flex-col items-center z-10">

        <section id="home-view" class="view-section active flex-col items-center justify-center text-center max-w-3xl w-full px-4">
            <div class="mb-8 relative group animate-slide-up">
                <div class="absolute -inset-10 bg-pink-600/20 rounded-full blur-3xl opacity-60"></div>
                <h1 class="relative font-display font-black text-5xl md:text-6xl tracking-tighter glow-white-inv pb-4 leading-tight transform transition hover:scale-105 duration-500 uppercase">
                    Box<br>
                    <span class="text-3xl md:text-4xl opacity-90">di</span><br>
                    San Valentino
                </h1>
            </div>
            <p class="text-white text-lg md:text-xl mb-12 font-medium max-w-xl leading-relaxed drop-shadow-lg animate-slide-up delay-100">
                Dillo con un messaggio anonimo. <br>
                <span class="glow-pink-inv font-bold">Lista 1</span>
            </p>
            
            <!-- COUNTDOWN SAN VALENTINO -->
            <div class="mb-10 animate-slide-up delay-100" id="countdownSection">
                <p class="text-white/60 text-xs font-bold uppercase tracking-widest mb-4">San Valentino tra...</p>
                <div class="countdown-box" id="countdownBox">
                    <div class="countdown-unit"><div class="countdown-number" id="cd-days">--</div><div class="countdown-label">Giorni</div></div>
                    <div class="countdown-unit"><div class="countdown-number" id="cd-hours">--</div><div class="countdown-label">Ore</div></div>
                    <div class="countdown-unit"><div class="countdown-number" id="cd-mins">--</div><div class="countdown-label">Minuti</div></div>
                    <div class="countdown-unit"><div class="countdown-number" id="cd-secs">--</div><div class="countdown-label">Secondi</div></div>
                </div>
                <div id="valentineMsg" class="hidden text-center mt-2">
                    <p class="text-2xl font-display font-black glow-pink-inv animate-pulse-slow">üíñ Buon San Valentino! üíñ</p>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-6 w-full justify-center max-w-md animate-slide-up delay-200">
                <button onclick="app.router('send')" class="transform transition hover:-translate-y-1 hover:shadow-2xl hover:shadow-white/30 bg-white text-nw-pink font-black py-5 px-10 rounded-2xl text-xl w-full shadow-lg flex items-center justify-center gap-3">
                    <span>INVIA üíå</span>
                </button>
                <button onclick="app.router('wall')" class="transform transition hover:-translate-y-1 glass-panel text-white border-white/40 border-2 font-bold py-5 px-10 rounded-2xl text-xl w-full hover:bg-white/10 flex items-center justify-center gap-3">
                   <span>BACHECA üíñ</span>
                </button>
            </div>
        </section>

        <section id="send-view" class="view-section flex-col items-center justify-start pt-10 px-4 w-full max-w-lg mx-auto">
            <div class="glass-panel p-8 md:p-12 rounded-[2rem] w-full relative overflow-hidden border-white/20 animate-slide-up">
                <h2 class="font-display font-black text-4xl mb-8 text-white glow-white-inv text-center">Scrivi il tuo messaggio</h2>
                <form id="sendForm" onsubmit="app.sendMessage(event)" class="space-y-6">
                    <div>
                        <label class="block text-xs font-bold text-white uppercase tracking-widest mb-2 ml-1">Per Chi? üíò</label>
                        <input type="text" id="toInput" required placeholder="Nome e Cognome" 
                            class="w-full bg-black/20 border-2 border-white/20 rounded-xl p-4 text-white placeholder-gray-300 focus:outline-none focus:border-white focus:ring-2 focus:ring-white/50 transition font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-white uppercase tracking-widest mb-2 ml-1">Classe (Opzionale)</label>
                        <input type="text" id="classInput" placeholder="Es. 5A INF" 
                            class="w-full bg-black/20 border-2 border-white/20 rounded-xl p-4 text-white placeholder-gray-300 focus:outline-none focus:border-white focus:ring-2 focus:ring-white/50 transition font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-white uppercase tracking-widest mb-2 ml-1">Messaggio üí¨</label>
                        <textarea id="msgInput" required rows="5" placeholder="Il tuo pensiero dolce o divertente..." 
                            class="w-full bg-black/20 border-2 border-white/20 rounded-xl p-4 text-white placeholder-gray-300 focus:outline-none focus:border-white focus:ring-2 focus:ring-white/50 transition font-medium resize-none"></textarea>
                    </div>
                    <button type="submit" id="submitBtn" class="w-full bg-white text-nw-pink font-black text-xl py-4 rounded-xl mt-6 shadow-lg transform transition hover:scale-[1.02] active:scale-95">
                        INVIA ORA üöÄ
                    </button>
                </form>
                <div id="successOverlay" class="absolute inset-0 bg-nw-red/95 flex flex-col items-center justify-center hidden z-10 text-center p-8 backdrop-blur-md">
                    <div class="text-7xl mb-4 animate-bounce">üíñ</div>
                    <h3 class="font-display font-black text-3xl text-white glow-white-inv mb-4">Inviato!</h3>
                    <p class="text-white text-lg">Il messaggio √® in coda di approvazione.</p>
                    <button onclick="app.router('home')" class="mt-8 bg-white/20 px-6 py-3 rounded-full text-white font-bold hover:bg-white/40 transition">Torna alla Home</button>
                </div>
                <div id="loadingOverlay" class="absolute inset-0 bg-black/60 flex items-center justify-center hidden z-20 backdrop-blur-sm">
                    <div class="loader"></div>
                </div>
            </div>
            <button onclick="app.router('home')" class="mt-8 mb-8 text-white/70 hover:text-white text-sm font-bold uppercase tracking-widest flex items-center gap-2 transition animate-slide-up delay-100">
                ‚Üê Indietro
            </button>
        </section>

        <section id="wall-view" class="view-section flex-col items-center w-full max-w-7xl px-4">
            <div class="text-center mb-8 relative animate-slide-up">
                <h2 class="inline-block font-display font-black text-5xl md:text-7xl px-2">
                    <span class="text-white glow-white-inv">WALL OF</span> <span class="glow-pink-inv">LOVE</span>
                </h2>
                <p class="text-white/80 mt-4 font-medium tracking-wider text-xl">
                    Le vostre dediche...
                    <span class="count-badge" id="wallCountBadge">0</span>
                </p>
            </div>
            <!-- SEARCH BAR -->
            <div class="w-full flex justify-center mb-8 animate-slide-up delay-100">
                <div class="relative w-full max-w-md">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-white/40 pointer-events-none">üîç</span>
                    <input type="text" id="wallSearch" class="search-bar pl-10" placeholder="Cerca per nome destinatario...">
                </div>
            </div>
            <div id="wallContainer" class="masonry-grid w-full px-2 min-h-[50vh] animate-slide-up delay-100">
                 <div class="flex justify-center w-full col-span-full py-20"><div class="loader"></div></div>
            </div>
            <div class="text-center mt-16 mb-20 animate-slide-up delay-200">
                <button onclick="app.router('home')" class="glass-panel px-8 py-4 rounded-full text-white font-bold hover:bg-white/20 transition transform hover:scale-105">
                    TORNA ALLA HOME üè†
                </button>
            </div>
        </section>

        <section id="admin-login-view" class="view-section flex-col items-center justify-center w-full max-w-md px-4 mx-auto">
            <div class="glass-panel p-10 rounded-3xl w-full border-2 border-white/20 shadow-2xl animate-slide-up">
                <h2 class="font-display font-black text-3xl text-white mb-8 text-center tracking-tight">‚ö†Ô∏è ADMIN ACCESS</h2>
                <form onsubmit="app.handleAdminLogin(event)" class="space-y-5">
                    <input type="email" id="adminEmail" placeholder="Email Admin" class="w-full bg-black/30 p-4 rounded-xl text-white border border-white/20 focus:border-white transition">
                    <input type="password" id="adminPass" placeholder="Password" class="w-full bg-black/30 p-4 rounded-xl text-white border border-white/20 focus:border-white transition">
                    <button type="submit" class="w-full bg-white text-nw-pink font-black py-4 rounded-xl transition shadow-lg text-lg transform hover:scale-[1.02]">LOGIN</button>
                </form>
                <p id="loginError" class="text-white font-bold text-sm mt-6 text-center hidden bg-red-600/50 p-2 rounded-lg">Errore.</p>
            </div>
            <button onclick="app.router('home')" class="mt-6 text-white/50 hover:text-white text-sm font-bold uppercase tracking-widest">Annulla</button>
        </section>

        <section id="admin-dashboard-view" class="view-section flex-col w-full max-w-7xl px-4 mx-auto pb-20">
            <!-- HEADER -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b-2 border-white/10 pb-6 gap-4 animate-slide-up">
                <div>
                    <h2 class="font-display font-black text-4xl text-white flex items-center gap-3">üõ°Ô∏è Moderazione</h2>
                    <p id="adminWelcomeMsg" class="text-white/60 text-sm mt-1 font-medium"></p>
                </div>
                <div class="flex gap-3 flex-wrap justify-end">
                    <button onclick="app.bulkSendEmails()" id="bulkEmailBtn" class="bg-pink-600/80 hover:bg-pink-500 text-white text-sm font-bold border border-pink-400/50 px-5 py-3 rounded-xl transition flex items-center gap-2">
                        üìß Invia email a tutti gli approvati
                    </button>
                    <button onclick="app.logout()" class="bg-white/10 text-white text-sm font-bold border-2 border-white/20 px-6 py-3 rounded-xl hover:bg-white hover:text-nw-pink transition">LOGOUT</button>
                </div>
            </div>
            <!-- BULK EMAIL PROGRESS -->
            <div id="bulkEmailProgress" class="hidden glass-panel p-5 rounded-2xl mb-6 animate-slide-up">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-white font-bold text-sm" id="bulkEmailStatus">Invio in corso...</p>
                    <span id="bulkEmailCounter" class="text-white/60 text-xs font-mono"></span>
                </div>
                <div class="w-full bg-white/10 rounded-full h-3">
                    <div id="bulkEmailBar" class="bg-gradient-to-r from-pink-500 to-red-400 h-3 rounded-full transition-all duration-300" style="width:0%"></div>
                </div>
                <div id="bulkEmailLog" class="mt-3 max-h-32 overflow-y-auto space-y-1 text-xs font-mono"></div>
            </div>
            <!-- TABS -->
            <div class="flex gap-2 mb-6 animate-slide-up">
                <button onclick="app.adminTab('pending')" id="tab-pending" class="admin-tab-btn active-tab px-5 py-2 rounded-xl font-bold text-sm transition">‚è≥ Da approvare <span class="count-badge" id="adminPendingCount">0</span></button>
                <button onclick="app.adminTab('approved')" id="tab-approved" class="admin-tab-btn px-5 py-2 rounded-xl font-bold text-sm transition">‚úÖ Approvati <span class="count-badge" id="adminApprovedCount">0</span></button>
                <button onclick="app.adminTab('searches')" id="tab-searches" class="admin-tab-btn px-5 py-2 rounded-xl font-bold text-sm transition">üîç Ricerche <span class="count-badge" id="adminSearchCount">0</span></button>
            </div>
            <!-- TAB PANELS -->
            <div class="animate-slide-up delay-200">
                <div id="adminPanel-pending" class="admin-panel glass-panel p-6 rounded-2xl border-white/20 flex flex-col h-[65vh]">
                    <div id="adminPendingContainer" class="space-y-4 overflow-y-auto flex-1"></div>
                </div>
                <div id="adminPanel-approved" class="admin-panel glass-panel p-6 rounded-2xl border-white/20 flex-col h-[65vh] hidden">
                    <div id="adminApprovedContainer" class="space-y-4 overflow-y-auto flex-1"></div>
                </div>
                <div id="adminPanel-searches" class="admin-panel glass-panel p-6 rounded-2xl border-white/20 flex-col h-[65vh] hidden">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-white/60 text-xs uppercase tracking-widest font-bold">Ricerche effettuate dagli utenti sul Wall</p>
                        <button onclick="app.clearSearches()" class="text-red-400 text-xs font-bold hover:text-red-300 transition">üóë Svuota</button>
                    </div>
                    <div id="adminSearchesContainer" class="space-y-2 overflow-y-auto flex-1"></div>
                </div>
            </div>
        </section>

        <footer class="w-full text-center py-8 mt-auto z-10 relative">
            <span id="secretTrigger" class="text-xs text-white/40 font-bold tracking-widest cursor-pointer hover:text-white transition select-none">
                LISTA 1 - VALENTINE EDITION
            </span>
        </footer>

    </main>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyAV0qbcowIWwGkmsps3bPBX5UhQpiJDAOQ",
            authDomain: "panetti-valentines.firebaseapp.com",
            projectId: "panetti-valentines",
            storageBucket: "panetti-valentines.firebasestorage.app",
            messagingSenderId: "639608037252",
            appId: "1:639608037252:web:fb83822e3161ddd399c7d1",
            measurementId: "G-V6FDZHQVPV"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, where, orderBy, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);
        const auth = getAuth(firebaseApp);

        // EmailJS
        emailjs.init('lE-RieCC6j9_M-S2r');

        // Admin welcome profiles
        const ADMIN_PROFILES = {
            'antonio@lista1.com': { greeting: 'Buongiorno', name: 'Antonio' },
            'admin@lista1.com':   { greeting: 'Benvenuto',  name: 'Danilo'  }
        };

        // Email helper: "Mario Rossi" ‚Üí { nome:"mario", cognome:"rossi", email:"rossi.mario@panettipitagora.edu.it" }
        function buildRecipient(toField) {
            const parts = toField.trim().toLowerCase().split(/\s+/);
            if (parts.length < 2) return null; // solo nome ‚Üí niente email
            const nome    = parts[0];
            const cognome = parts[parts.length - 1];
            return {
                nome,
                cognome,
                email: `${cognome}.${nome}@panettipitagora.edu.it`,
                displayName: toField.trim()
            };
        }

        function createHeartsBg() {
            const container = document.getElementById('heartsBg');
            const heartCount = 35; 
            const colors = ['#ffffff', '#FF4081', '#FFB7C5'];
            container.innerHTML = '';
            for (let i = 0; i < heartCount; i++) {
                const heart = document.createElement('div');
                heart.className = 'heart-particle';
                heart.innerHTML = 'üíñ'; 
                const size = Math.random() * 1.5 + 0.8;
                heart.style.fontSize = `${size}rem`;
                heart.style.left = `${Math.random() * 100}%`;
                heart.style.color = colors[Math.floor(Math.random() * colors.length)];
                heart.style.opacity = Math.random() * 0.5 + 0.2;
                const duration = Math.random() * 12 + 10; 
                const delay = Math.random() * 15;
                heart.style.animationDuration = `${duration}s`;
                heart.style.animationDelay = `-${delay}s`;
                container.appendChild(heart);
            }
        }
        createHeartsBg();

        // COUNTDOWN SAN VALENTINO
        function updateCountdown() {
            const now = new Date();
            const year = now.getMonth() >= 1 && now.getDate() > 14 ? now.getFullYear() + 1 : now.getFullYear();
            const vDay = new Date(year, 1, 14, 0, 0, 0); // 14 Feb
            const diff = vDay - now;

            if (diff <= 0) {
                document.getElementById('countdownBox')?.classList.add('hidden');
                document.getElementById('valentineMsg')?.classList.remove('hidden');
                return;
            }

            const days    = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours   = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            const pad = n => String(n).padStart(2, '0');
            document.getElementById('cd-days').textContent  = pad(days);
            document.getElementById('cd-hours').textContent = pad(hours);
            document.getElementById('cd-mins').textContent  = pad(minutes);
            document.getElementById('cd-secs').textContent  = pad(seconds);
        }
        updateCountdown();
        setInterval(updateCountdown, 1000);

        const appState = { currentUser: null, unsubscribeWall: null, unsubscribeAdminPending: null, unsubscribeAdminApproved: null, secretClicks: 0 };

        window.app = {
            router: (viewName) => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                document.querySelectorAll('.view-section').forEach(el => {
                    el.classList.remove('active');
                    setTimeout(() => { if(!el.classList.contains('active')) el.style.display = 'none'; }, 300);
                });
                const target = document.getElementById(`${viewName}-view`);
                if (target) {
                    target.style.display = 'flex';
                    setTimeout(() => target.classList.add('active'), 50);
                }
                if (viewName === 'wall') loadWallMessages();
                if (viewName === 'admin-dashboard') loadAdminMessagesV2();
            },

            adminTab: (tab) => {
                ['pending','approved','searches'].forEach(t => {
                    document.getElementById(`adminPanel-${t}`)?.classList.add('hidden');
                    document.getElementById(`tab-${t}`)?.classList.remove('active-tab');
                });
                document.getElementById(`adminPanel-${tab}`)?.classList.remove('hidden');
                document.getElementById(`tab-${tab}`)?.classList.add('active-tab');
                if (tab === 'searches') loadAdminSearches();
            },

            sendMessage: async (e) => {
                e.preventDefault();
                const loader = document.getElementById('loadingOverlay');
                const success = document.getElementById('successOverlay');
                loader.classList.remove('hidden');
                try {
                    await addDoc(collection(db, "messages"), {
                        to: document.getElementById('toInput').value,
                        class: document.getElementById('classInput').value,
                        message: document.getElementById('msgInput').value,
                        status: "pending",
                        timestamp: serverTimestamp()
                    });
                    loader.classList.add('hidden');
                    success.classList.remove('hidden');
                    document.getElementById('sendForm').reset();
                } catch (error) {
                    loader.classList.add('hidden');
                    alert("Errore invio.");
                }
            },

            handleAdminLogin: async (e) => {
                e.preventDefault();
                const email = document.getElementById('adminEmail').value;
                const pass = document.getElementById('adminPass').value;
                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                    document.getElementById('loginError').classList.add('hidden');
                } catch (error) {
                    document.getElementById('loginError').classList.remove('hidden');
                }
            },

            logout: () => { signOut(auth).then(() => window.app.router('home')); },

            approveMsg: async (id, toField, messageText) => {
                try {
                    const recipient = buildRecipient(toField);
                    let emailStatus = 'skipped';

                    if (recipient) {
                        const searchParam = encodeURIComponent(recipient.displayName);
                        const messageLink = `https://sanvalentino.github.io/valentines-app/?cerca=${searchParam}`;
                        try {
                            await emailjs.send('service_9q1hgoj', 'template_mtwvh4w', {
                                to_email:     recipient.email,
                                to_name:      recipient.nome.charAt(0).toUpperCase() + recipient.nome.slice(1),
                                message_link: messageLink
                            });
                            emailStatus = 'sent';
                            console.log(`‚úÖ Email inviata a ${recipient.email}`);
                        } catch (emailErr) {
                            emailStatus = 'failed';
                            console.error(`‚ùå Email fallita per ${recipient.email}:`, emailErr);
                        }
                    } else {
                        console.log(`‚è≠Ô∏è Nessuna email: nome incompleto per "${toField}"`);
                    }

                    await updateDoc(doc(db, "messages", id), {
                        status: "approved",
                        emailStatus,
                        emailAddress: recipient ? recipient.email : null
                    });
                } catch(e) {
                    console.error("Errore approvazione:", e);
                }
            },

            deleteMsg: async (id) => {
                if(confirm("Eliminare?")) {
                    try { await deleteDoc(doc(db, "messages", id)); } catch(e) {}
                }
            },

            clearSearches: async () => {
                if (!confirm("Svuotare tutte le ricerche?")) return;
                try {
                    const snap = await new Promise(res => {
                        const unsub = onSnapshot(collection(db, "searches"), s => { unsub(); res(s); });
                    });
                    for (const d of snap.docs) await deleteDoc(doc(db, "searches", d.id));
                    document.getElementById('adminSearchesContainer').innerHTML = '<p class="text-white/40 text-sm text-center py-10">Nessuna ricerca salvata.</p>';
                } catch(e) { console.error(e); }
            },

            bulkSendEmails: async () => {
                if (!confirm("Inviare email a TUTTI i messaggi approvati che non l'hanno ancora ricevuta?\n\nQuesta operazione potrebbe inviare fino a 100+ email.")) return;

                const progressBox  = document.getElementById('bulkEmailProgress');
                const statusEl     = document.getElementById('bulkEmailStatus');
                const counterEl    = document.getElementById('bulkEmailCounter');
                const barEl        = document.getElementById('bulkEmailBar');
                const logEl        = document.getElementById('bulkEmailLog');
                const btn          = document.getElementById('bulkEmailBtn');

                progressBox.classList.remove('hidden');
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                logEl.innerHTML = '';

                const addLog = (msg, color = 'text-white/50') => {
                    const line = document.createElement('p');
                    line.className = color;
                    line.textContent = msg;
                    logEl.prepend(line);
                };

                try {
                    // Carica tutti gli approvati senza emailStatus
                    const snap = await getDocs(query(collection(db, "messages"), where("status", "==", "approved")));
                    const toProcess = [];
                    snap.forEach(d => {
                        const data = d.data();
                        if (!data.emailStatus) toProcess.push({ id: d.id, ...data });
                    });

                    if (toProcess.length === 0) {
                        statusEl.textContent = '‚úÖ Tutti i messaggi approvati hanno gi√† ricevuto l\'email!';
                        barEl.style.width = '100%';
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        return;
                    }

                    statusEl.textContent = `Invio in corso... (0 / ${toProcess.length})`;
                    let sent = 0, failed = 0, skipped = 0;

                    for (let i = 0; i < toProcess.length; i++) {
                        const item = toProcess[i];
                        const recipient = buildRecipient(item.to || '');
                        let emailStatus = 'skipped';

                        if (recipient) {
                            try {
                                const searchParam = encodeURIComponent(recipient.displayName);
                                const messageLink = `https://sanvalentino.github.io/valentines-app/?cerca=${searchParam}`;
                                await emailjs.send('service_9q1hgoj', 'template_mtwvh4w', {
                                    to_email:     recipient.email,
                                    to_name:      recipient.nome.charAt(0).toUpperCase() + recipient.nome.slice(1),
                                    message_link: messageLink
                                });
                                emailStatus = 'sent';
                                sent++;
                                addLog(`‚úÖ Inviata ‚Üí ${recipient.email}`, 'text-green-400');
                                console.log(`‚úÖ [${i+1}/${toProcess.length}] Email inviata a ${recipient.email}`);
                            } catch(err) {
                                emailStatus = 'failed';
                                failed++;
                                addLog(`‚ùå Fallita ‚Üí ${recipient.email}`, 'text-red-400');
                                console.error(`‚ùå [${i+1}/${toProcess.length}] Fallita per ${recipient.email}:`, err);
                            }
                        } else {
                            skipped++;
                            addLog(`‚è≠Ô∏è Skip ‚Üí "${item.to}" (nome incompleto)`, 'text-white/30');
                        }

                        // Aggiorna Firestore
                        await updateDoc(doc(db, "messages", item.id), {
                            emailStatus,
                            emailAddress: recipient ? recipient.email : null
                        });

                        // Aggiorna UI
                        const progress = Math.round(((i + 1) / toProcess.length) * 100);
                        barEl.style.width = `${progress}%`;
                        counterEl.textContent = `${i + 1} / ${toProcess.length}`;
                        statusEl.textContent = `Invio in corso... (${i + 1} / ${toProcess.length})`;

                        // Pausa tra invii per non superare i limiti EmailJS
                        if (i < toProcess.length - 1) await new Promise(r => setTimeout(r, 300));
                    }

                    statusEl.textContent = `üéâ Completato! ‚úÖ ${sent} inviate  ‚ùå ${failed} fallite  ‚è≠Ô∏è ${skipped} skip`;
                    barEl.style.width = '100%';
                    console.log(`\nüìä Riepilogo bulk: ${sent} inviate, ${failed} fallite, ${skipped} saltate`);

                } catch(err) {
                    statusEl.textContent = '‚ùå Errore durante il processo.';
                    console.error('Errore bulk:', err);
                }

                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };

        let wallMessagesCache = [];

        function formatTimestamp(ts) {
            if (!ts) return '';
            const date = ts.toDate ? ts.toDate() : new Date(ts);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            if (diffMins < 1) return 'proprio ora';
            if (diffMins < 60) return `${diffMins} min fa`;
            if (diffHours < 24) return `${diffHours} ${diffHours > 1 ? 'ore' : 'ora'} fa`;
            if (diffDays === 1) return 'ieri';
            if (diffDays < 7) return `${diffDays} giorni fa`;
            return date.toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
        }

        function renderWallCards(messages) {
            const container = document.getElementById('wallContainer');
            container.innerHTML = '';
            if (messages.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center py-20 text-white/60">Nessun messaggio trovato.</p>';
                return;
            }
            messages.forEach((data) => {
                const card = document.createElement('div');
                card.className = "masonry-item glass-panel p-6 rounded-3xl animate-slide-up hover:bg-white/5 transition";
                card.innerHTML = `
                    <div class="mb-3 border-b border-white/10 pb-2">
                        <h3 class="font-bold text-white text-lg">Per: ${escapeHtml(data.to)}</h3>
                        <span class="text-xs text-white/50">${data.class || ''}</span>
                    </div>
                    <p class="text-white font-medium italic">"${escapeHtml(data.message)}"</p>
                    <p class="msg-timestamp">üïê ${formatTimestamp(data.timestamp)}</p>
                `;
                container.appendChild(card);
            });
        }

        function loadWallMessages() {
            if (appState.unsubscribeWall) appState.unsubscribeWall();
            const q = query(collection(db, "messages"), where("status", "==", "approved"), orderBy("timestamp", "desc"));
            const container = document.getElementById('wallContainer');
            container.innerHTML = '<div class="flex justify-center w-full col-span-full py-20"><div class="loader"></div></div>';

            appState.unsubscribeWall = onSnapshot(q, (snapshot) => {
                wallMessagesCache = [];
                snapshot.forEach((docSnap) => {
                    wallMessagesCache.push({ id: docSnap.id, ...docSnap.data() });
                });

                // Update live count badge
                const badge = document.getElementById('wallCountBadge');
                if (badge) badge.textContent = wallMessagesCache.length;

                // Apply current search filter
                const searchVal = (document.getElementById('wallSearch')?.value || '').toLowerCase().trim();
                const filtered = searchVal
                    ? wallMessagesCache.filter(d => d.to && d.to.toLowerCase().includes(searchVal))
                    : wallMessagesCache;

                if (snapshot.empty) {
                    container.innerHTML = '<p class="col-span-full text-center py-20 text-white/60">Ancora nessun messaggio.</p>';
                    return;
                }
                renderWallCards(filtered);
            });

            // Wire up search input (once)
            const searchInput = document.getElementById('wallSearch');
            if (searchInput && !searchInput._listenerAttached) {
                searchInput._listenerAttached = true;
                let searchDebounce = null;
                searchInput.addEventListener('input', () => {
                    const val = searchInput.value.toLowerCase().trim();
                    const filtered = val
                        ? wallMessagesCache.filter(d => d.to && d.to.toLowerCase().includes(val))
                        : wallMessagesCache;
                    renderWallCards(filtered);

                    // Traccia ricerca su Firestore (debounce 1.5s, min 2 char)
                    clearTimeout(searchDebounce);
                    if (val.length >= 2) {
                        searchDebounce = setTimeout(async () => {
                            try {
                                await addDoc(collection(db, "searches"), {
                                    query: val,
                                    timestamp: serverTimestamp()
                                });
                            } catch(e) {}
                        }, 1500);
                    }
                });
            }
        }

        function loadAdminMessagesV2() {
            if (!auth.currentUser) return;
            const pendingContainer = document.getElementById('adminPendingContainer');
            const approvedContainer = document.getElementById('adminApprovedContainer');

            onSnapshot(query(collection(db, "messages"), where("status", "==", "pending"), orderBy("timestamp", "desc")), (snap) => {
                pendingContainer.innerHTML = '';
                const badge = document.getElementById('adminPendingCount');
                if (badge) badge.textContent = snap.size;
                if (snap.empty) {
                    pendingContainer.innerHTML = '<p class="text-white/40 text-sm text-center py-10">Nessun messaggio in attesa.</p>';
                    return;
                }
                snap.forEach(d => {
                    const data = d.data();
                    const recipient = buildRecipient(data.to || '');
                    const emailPreview = recipient
                        ? `<span class="text-xs text-white/40">üìß ${recipient.email}</span>`
                        : `<span class="text-xs text-yellow-400/70">‚ö†Ô∏è Nome incompleto ‚Äì nessuna email</span>`;
                    const el = document.createElement('div');
                    el.className = "bg-white/10 p-4 rounded-xl";
                    el.innerHTML = `
                        <p class="text-xs text-white/50 font-bold">${escapeHtml(data.to || '')} <span class="text-white/30">${data.class || ''}</span></p>
                        <p class="my-2 text-white">${escapeHtml(data.message || '')}</p>
                        ${emailPreview}
                        <p class="text-xs text-white/30 mb-2">${formatTimestamp(data.timestamp)}</p>
                        <div class="flex gap-2 mt-2">
                            <button onclick="app.approveMsg('${d.id}', ${JSON.stringify(data.to || '')}, ${JSON.stringify(data.message || '')})" 
                                class="bg-green-500 hover:bg-green-400 p-2 rounded-lg flex-1 font-bold text-sm transition">‚úÖ Approva</button>
                            <button onclick="app.deleteMsg('${d.id}')" 
                                class="bg-red-500 hover:bg-red-400 p-2 rounded-lg flex-1 font-bold text-sm transition">üóë Elimina</button>
                        </div>`;
                    pendingContainer.appendChild(el);
                });
            });

            onSnapshot(query(collection(db, "messages"), where("status", "==", "approved"), orderBy("timestamp", "desc")), (snap) => {
                approvedContainer.innerHTML = '';
                const badge = document.getElementById('adminApprovedCount');
                if (badge) badge.textContent = snap.size;
                if (snap.empty) {
                    approvedContainer.innerHTML = '<p class="text-white/40 text-sm text-center py-10">Nessun messaggio approvato.</p>';
                    return;
                }
                snap.forEach(d => {
                    const data = d.data();
                    let emailBadgeHtml = '';
                    if (data.emailStatus === 'sent') {
                        emailBadgeHtml = `<span class="email-badge email-sent">‚úÖ Email inviata a ${escapeHtml(data.emailAddress || '')}</span>`;
                    } else if (data.emailStatus === 'failed') {
                        emailBadgeHtml = `<span class="email-badge email-failed">‚ùå Email fallita ‚Äì ${escapeHtml(data.emailAddress || '')}</span>`;
                    } else if (data.emailStatus === 'skipped') {
                        emailBadgeHtml = `<span class="email-badge email-skipped">‚è≠Ô∏è Nessuna email (nome incompleto)</span>`;
                    } else {
                        emailBadgeHtml = `<span class="email-badge email-skipped">‚è≠Ô∏è Approvato senza email</span>`;
                    }
                    const el = document.createElement('div');
                    el.className = "bg-white/5 p-4 rounded-xl";
                    el.innerHTML = `
                        <p class="text-xs text-white/50 font-bold">${escapeHtml(data.to || '')}</p>
                        <p class="my-2 text-white text-sm">${escapeHtml(data.message || '')}</p>
                        ${emailBadgeHtml}
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-xs text-white/30">${formatTimestamp(data.timestamp)}</span>
                            <button onclick="app.deleteMsg('${d.id}')" class="text-red-400 text-xs hover:text-red-300 transition font-bold">üóë Elimina</button>
                        </div>`;
                    approvedContainer.appendChild(el);
                });
            });
        }

        function loadAdminSearches() {
            const container = document.getElementById('adminSearchesContainer');
            container.innerHTML = '<div class="flex justify-center py-10"><div class="loader"></div></div>';
            const q = query(collection(db, "searches"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snap) => {
                const badge = document.getElementById('adminSearchCount');
                if (badge) badge.textContent = snap.size;
                container.innerHTML = '';
                if (snap.empty) {
                    container.innerHTML = '<p class="text-white/40 text-sm text-center py-10">Nessuna ricerca salvata.</p>';
                    return;
                }
                snap.forEach(d => {
                    const data = d.data();
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center bg-white/5 px-4 py-2 rounded-lg";
                    el.innerHTML = `
                        <span class="text-white font-medium">üîç ${escapeHtml(data.query || '')}</span>
                        <span class="text-white/40 text-xs">${formatTimestamp(data.timestamp)}</span>`;
                    container.appendChild(el);
                });
            });
        }

        function escapeHtml(text) { if (!text) return ""; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

        onAuthStateChanged(auth, (user) => {
            appState.currentUser = user;
            if (user) {
                // Welcome message personalizzato
                const profile = ADMIN_PROFILES[user.email];
                const welcomeEl = document.getElementById('adminWelcomeMsg');
                if (welcomeEl) {
                    if (profile) {
                        welcomeEl.textContent = `${profile.greeting}, ${profile.name}! üëã`;
                    } else {
                        const name = user.email.split('@')[0];
                        welcomeEl.textContent = `Benvenuto, ${name}! üëã`;
                    }
                }
                if (document.getElementById('admin-login-view').classList.contains('active')) {
                    window.app.router('admin-dashboard');
                }
            }
        });

        // Gestione URL ?cerca= ‚Üí vai al wall con ricerca pre-impostata
        (function handleUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const cerca = params.get('cerca');
            if (cerca) {
                window.app.router('wall');
                // Aspetta che il wall sia caricato e imposta la ricerca
                const trySetSearch = setInterval(() => {
                    const input = document.getElementById('wallSearch');
                    if (input) {
                        input.value = cerca;
                        input.dispatchEvent(new Event('input'));
                        clearInterval(trySetSearch);
                    }
                }, 200);
            }
        })();

        document.getElementById('secretTrigger').addEventListener('click', () => {
            appState.secretClicks++;
            if (appState.secretClicks === 5) {
                appState.secretClicks = 0;
                appState.currentUser ? window.app.router('admin-dashboard') : window.app.router('admin-login');
            }
        });
    </script>
</body>
</html>
